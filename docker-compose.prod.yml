# PRODUCTION DOCKER COMPOSE - Modern Best Practices
# Data persists in Docker named volumes (stored on your SSD at /var/lib/docker/volumes/)
# .env file should be at /opt/shoppinglist/.env on your host server

services:
  app:
    # Use pre-built image from GitHub Container Registry
    # Image is automatically built on every push to main branch
    image: ghcr.io/robertobarlocci/shoppinglist:latest
    build:
      context: .
      dockerfile: docker/php/Dockerfile
      args:
        - PHP_VERSION=8.3
    container_name: chnubber-app
    restart: unless-stopped
    working_dir: /var/www

    # Volumes: Code + Persistent Storage
    volumes:
      # Application code (read-only in production for security)
      - ./:/var/www:ro
      # Laravel storage MUST be writable (logs, cache, sessions, uploads)
      - storage-data:/var/www/storage
      - bootstrap-cache:/var/www/bootstrap/cache
      # PHP config
      - ./docker/php/local.ini:/usr/local/etc/php/conf.d/local.ini:ro

    networks:
      - chnubber-network

    # Environment variables from host .env file
    env_file:
      - .env

    # Healthcheck: Verify PHP-FPM master process is running
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep -v grep | grep 'php-fpm: master' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

    # Resource limits (adjust based on your server)
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    depends_on:
      - db
      - redis

  nginx:
    image: nginx:1.25-alpine
    container_name: chnubber-nginx
    restart: unless-stopped

    ports:
      - "${APP_PORT:-8585}:80"

    volumes:
      # Application public files (read-only)
      - ./public:/var/www/public:ro
      # Built assets
      - ./public/build:/var/www/public/build:ro
      # Nginx config
      - ./docker/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro

    networks:
      - chnubber-network

    # Healthcheck: Verify Nginx is responding
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/up"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 128M
        reservations:
          cpus: '0.25'
          memory: 64M

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    depends_on:
      - app

  db:
    image: postgres:16-alpine
    container_name: chnubber-db
    restart: unless-stopped

    environment:
      POSTGRES_DB: ${DB_DATABASE:-chnubber}
      POSTGRES_USER: ${DB_USERNAME:-chnubber}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-secret}
      PGDATA: /var/lib/postgresql/data/pgdata
      # Performance tuning
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=C"

    # CRITICAL: Named volume for database persistence
    # Physical location: /var/lib/docker/volumes/shoppinglist_postgres-data/_data/
    # This survives container updates, recreations, and restarts
    volumes:
      - postgres-data:/var/lib/postgresql/data

    # Expose port for backups/admin access (restrict in firewall!)
    ports:
      - "127.0.0.1:54321:5432"  # Only accessible from localhost

    networks:
      - chnubber-network

    # Healthcheck: Verify PostgreSQL is accepting connections
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USERNAME:-chnubber} -d ${DB_DATABASE:-chnubber}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Shared memory for PostgreSQL (improves performance)
    shm_size: 128mb

  redis:
    image: redis:7-alpine
    container_name: chnubber-redis
    restart: unless-stopped

    # Redis persistence configuration
    command: redis-server --appendonly yes --appendfsync everysec --maxmemory 256mb --maxmemory-policy allkeys-lru

    # CRITICAL: Named volume for Redis persistence (optional, can be ephemeral)
    volumes:
      - redis-data:/data

    # Expose port for monitoring (restrict in firewall!)
    ports:
      - "127.0.0.1:63791:6379"  # Only accessible from localhost

    networks:
      - chnubber-network

    # Healthcheck: Verify Redis is responding
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  scheduler:
    build:
      context: .
      dockerfile: docker/php/Dockerfile
    container_name: chnubber-scheduler
    restart: unless-stopped
    working_dir: /var/www

    volumes:
      - ./:/var/www:ro
      - storage-data:/var/www/storage

    networks:
      - chnubber-network

    env_file:
      - .env

    command: php artisan schedule:work

    deploy:
      resources:
        limits:
          cpus: '0.25'
          memory: 128M
        reservations:
          cpus: '0.1'
          memory: 64M

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    depends_on:
      app:
        condition: service_healthy
      db:
        condition: service_healthy
      redis:
        condition: service_healthy

  queue:
    build:
      context: .
      dockerfile: docker/php/Dockerfile
    container_name: chnubber-queue
    restart: unless-stopped
    working_dir: /var/www

    volumes:
      - ./:/var/www:ro
      - storage-data:/var/www/storage

    networks:
      - chnubber-network

    env_file:
      - .env

    command: php artisan queue:work --tries=3 --timeout=60 --sleep=3 --max-jobs=1000 --max-time=3600

    # Healthcheck: Verify queue worker is running
    healthcheck:
      test: ["CMD", "pgrep", "-f", "artisan queue:work"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s

    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.25'
          memory: 128M

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    depends_on:
      app:
        condition: service_healthy
      db:
        condition: service_healthy
      redis:
        condition: service_healthy

networks:
  chnubber-network:
    driver: bridge
    name: chnubber-network

# CRITICAL: Named Volumes for Data Persistence
# These are stored on your server's SSD at /var/lib/docker/volumes/
# They persist across container updates, recreations, and restarts
# NEVER delete these volumes unless you want to lose data!
volumes:
  # PostgreSQL database - MOST CRITICAL
  # Contains all your application data
  postgres-data:
    driver: local
    name: shoppinglist_postgres-data

  # Redis cache/queue data
  # Less critical, can be rebuilt
  redis-data:
    driver: local
    name: shoppinglist_redis-data

  # Laravel storage (logs, cache, sessions, uploads)
  # Important for uploaded files and logs
  storage-data:
    driver: local
    name: shoppinglist_storage-data

  # Laravel bootstrap cache
  # Can be rebuilt, but good to persist
  bootstrap-cache:
    driver: local
    name: shoppinglist_bootstrap-cache
